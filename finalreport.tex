\documentclass[11pt]{article}
\usepackage[T1]{fontenc}
\usepackage[english]{babel}
\usepackage{fullpage}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{amsfonts}
\usepackage{amsmath}
\usepackage{placeins}

\newcommand{\HRule}{\rule{\linewidth}{0.5mm}}
%\def\wl{\par \vspace{\baselineskip}}

\begin{document}

% TITLE PAGE
\begin{titlepage}
	\begin{center}

% Header
\textsc{\LARGE AA241X: Design, Construction, and Testing of Autonomous Aircraft}\\
\HRule \\[0.4cm]
\includegraphics[width=1.0\textwidth]{./skynet}~\\
\HRule \\[0.4cm]
\textsc{\Large Final Report}\\
{\large \today}
\vfill

% Authors
\begin{minipage}{0.4\textwidth}
	\begin{flushleft} \large
	\emph{Authors:}\\[0.5cm]
	Kartikey Asthana\\
	\texttt{kasthana@stanford.edu}\\[0.5cm]
	Peter Blake\\
	\texttt{psblake@stanford.edu}\\[0.5cm]
	Brandon Jennings\\
	\texttt{bjennin@stanford.edu}\\[0.5cm]
	Erik Moon\\
	\texttt{emoon1@stanford.edu}\\[0.5cm]
	Sravya Nimmagadda\\
	\texttt{sravya@stanford.edu}\\[0.5cm]
	Akshay Subramaniam\\
	\texttt{akshays@stanford.edu}\\[0.5cm]
	Ian Villa\\
	\texttt{ianvilla@stanford.edu}\\[0.5cm]
	Jerry Watkins\\
	\texttt{watkins2@stanford.edu}\\[0.5cm]
\end{flushleft}
\end{minipage}
\begin{minipage}{0.4\textwidth}
	\begin{flushright} \large
	\emph{Degree \& Department:} \\[0.5cm]
	Ph.D. Candidate\\
	Aeronautics \& Astronautics\\[0.5cm]
	M.S. Candidate\\
	Graduate School of Business\\[0.5cm]
	M.S. Candidate\\
	Mechanical Engineering\\[0.5cm]
	M.S. Candidate\\
	Graduate School of Business\\[0.5cm]
	Ph.D. Candidate\\
	Aeronautics \& Astronautics\\[0.5cm]
	Ph.D. Candidate\\
	Aeronautics \& Astronautics\\[0.5cm]
	B.S. \& M.S. Candidate\\
	Aeronautics \& Astronautics\\[0.5cm]
	Ph.D. Candidate\\
	Aeronautics \& Astronautics\\[0.5cm]
\end{flushright}
\end{minipage}
\end{center}
\end{titlepage}

% TABLE OF CONTENTS
\clearpage
\tableofcontents
\vfill
\clearpage

\section{Introduction}
	\label{Introduction}
	Since the early 2000's, Stanford Aeronautics and Astronautics has taught the AA 241X: Design, Construction and Testing of Autonomous Aircraft course with various missions over the years. In Spring of 2014, teams were tasked with developing an autonomous aircraft to search and accurately locate four targets within the perimeter of Lake Lagunita. Among these teams was Skynet, a group of eight individuals from different backgrounds and expertise who, throughout the ten weeks, collaborated to organize, design, test, and fly various aircraft, guidance, control, and mission systems to optimally complete the search and rescue. The following report outlines the team's structure, mission strategy, aerodynamic design, control strategy, fabrication accounts, flight test data, and overall competition performance.

	\section{The Team}
		\label{Team}
		\subsection{Team Structure}
		\label{TeamStrc}
		Skynet began as a team of eight individuals from Stanford Aeronautics and Astronautics, Mechanical Engineering, and the Graduate School of Business. In order to effectively tackle the assigned problem sets and deadlines, the team began by designating Ian as team lead and the other members as sub team leaders in the different disciplines required by the class. These areas were Aerodynamics/Configuration Design/Propulsion, Guidance/Navigation/Control, Hardware/Fabrication, Software, Aircraft Performance, and Mission Planning as outlined in the first lecture by Professor Alonso. The initial team structure is outlined in Table~\ref{initTeam}.

		\begin{table}[!ht]
			\begin{center}
				\begin{tabular}{| p{7.5cm} | c | p{3.7cm} |}
					\hline
					\textbf{Initial Design Sub-Teams} & \textbf{Lead} & \textbf{Members} \\ \hline
					Aerodynamics/Configuration Design, Propellers/Propulsion & Jerry, Akshay, Kartikey & Sravya, Ian \\ \hline
					Guidance, Navigation \& Control & Brandon & Jerry, Sravya, Akshay \\ \hline
					Hardware & Erik & Brandon, Peter \\ \hline
					Software & Ian & Brandon, Erik, Jerry, Akshay, Sravya, Kartikey \\ \hline
					Aircraft Performance & Sravya & Jerry, Akshay, Ian, Peter, Kartikey \\ \hline
					Mission Planning & Peter & Everyone \\ \hline
					Fabrication & Erik & Brandon, Peter, Akshay, Jerry, Kartikey \\ \hline
				\end{tabular}
				\caption{Initial Team Divisions}
				\label{initTeam}
			\end{center}
		\end{table}

		For flying, our team had two designated pilots and launchers respectively as seen in Table~\ref{initFltTeam}. For each flight, at least one pilot was present and one launcher was present with a flight director also available depending on what code was being tested.

		\begin{table}[!ht]
			\begin{center}
				\begin{tabular}{| c | c |}
					\hline
					\textbf{Flight Team Role} & \textbf{Members} \\ \hline
					Pilots & Peter \& Brandon \\ \hline
					Launchers/Flight Directors & Jerry \& Ian \\ \hline
				\end{tabular}
				\caption{Initial Flight Team}
				\label{initFltTeam}
			\end{center}
		\end{table}

		As problem set tasks and goals were more concretely defined, the team structure evolved depending on the roles members acquired. Sub teams and member roles were redefined and grouped accordingly. Since software was strongly tied to the aircraft performance, mission planning, and guidance, navigation, \& control sub teams, the sub team was dissolved with a new focus on systems and logistics. As our mission strategy grew in complexity, Kartikey took the helm as lead with his specialties in numerics. Sub team integration and communication was aided by the fact that members in the flight team were leading separate design sub teams and that there was just the right amount of overlap between divisions. Mid-quarter team configurations are outlined in Table~\ref{midTeam}.

		\begin{table}[!ht]
			\begin{center}
				\begin{tabular}{| p{7.5cm} | c | p{3.7cm} |}
					\hline
					\textbf{Mid-Quarter Design Sub-Teams} & \textbf{Lead} & \textbf{Members} \\ \hline
					Aerodynamics/Configuration Design, Propellers/Propulsion & Akshay, Sravya & \\ \hline
					Guidance, Navigation \& Control & Brandon & Jerry, Ian, Peter \\ \hline
					Hardware/Fabrication & Erik & Brandon, Peter, Ian, Akshay \\ \hline
					Systems/Logistics & Ian & Brandon, Jerry \\ \hline
					Aircraft Performance & Sravya, Jerry & Akshay, Kartikey \\ \hline
					Mission Planning & Kartikey & Everyone \\ \hline
				\end{tabular}
				\caption{Mid-Quarter Team Divisions}
				\label{midTeam}
			\end{center}
		\end{table}

		From week eight onward, our aerodynamic design was finalized which meant that the aerodynamic divisions could be absorbed by the other sub teams. Because of the level of complexity of our mission strategy, we needed more time to port our matlab codes and functions to the APM which lead to a majority of the team working on software and a light, efficient squad left for fabrication and repairs. As flying became more critical, we decided on a primary pilot for testing and introduced other flight directors as needed for testing of specific pieces of code. Our final sub team layout and flight teams are in Table~\ref{finalTeam} and in Table~\ref{finalFltTeam} respectively.

		\begin{table}[!ht]
			\begin{center}
				\begin{tabular}{| p{7.5cm} | c | p{3.7cm} |}
					\hline
					\textbf{Final Design Sub-Teams} & \textbf{Lead} & \textbf{Members} \\ \hline
					Guidance, Navigation \& Control & Brandon & Jerry, Ian, Peter \\ \hline
					Hardware/Fabrication & Erik & Peter, Ian \\ \hline
					Systems/Logistics & Ian & Brandon, Jerry \\ \hline
					Mission Planning & Kartikey & Jerry, Akshay, Sravya \\ \hline
				\end{tabular}
				\caption{Final Team Divisions}
				\label{finalTeam}
			\end{center}
		\end{table}

		\begin{table}[!ht]
			\begin{center}
				\begin{tabular}{| c | p{7cm} |}
					\hline
					\textbf{Flight Team Role} & \textbf{Members} \\ \hline
					Pilots & Peter (Competition) \& Brandon (Testing) \\ \hline
					Launchers & Jerry, Ian, Akshay, Kartikey \\ \hline
					Flight Directors & Brandon (Controls), Jerry (Phase 1), Akshay \& Kartikey (Phase 2), Ian (Backup) \\ \hline
				\end{tabular}
				\caption{Final Flight Team}
				\label{finalFltTeam}
			\end{center}
		\end{table}

		\subsection{Team Communication \& Logistics}
		\label{TeamCommLog}
		In order to facilitate group discussions, a when2meet form was utilized online. Based on its results, the team met briefly after class on Mondays and Wednesdays for brief sub team status updates and coordination. Major team meetings were held on Fridays during the typical class time on the second floor of Durand and were spent discussing topics requiring everyone's attendance such as aircraft design and mission strategy.

		The team also utilized online methods to meet communication needs. A Google Group was utilized for formalized notices and e-mail discussions. Short-form and quick information relays were handled by a GroupMe that could be accessed via phone or computer. 

		Prior to week 6, flight testing was scheduled as needed since precedence was placed on airframe and mission strategy development. However, once control laws and mission code needed to be tested in the air, it became apparent that a regular schedule needed to be enforced for sufficient project progress. Flight teams as outlined in Section~\ref{TeamStrc} met at Durand 353 nearly every day of the week at 6:00am. Once logs had been cleared and updates had been pushed to the APM, the flight team would head out to Lake Lagunita around 6:30am and fly until 11:00am on good days and 8:30am on bad days. Phone calls were used to communicate for the entire pre-flight and flight duration for real-time updates. Intermittent updates and summaries were sent to team members not present over the GroupMe. Towards the competition week, flight teams would arrive earlier to fly sooner.

		Data Storage and problem set completion was made possible via our Google Drive, Google Docs, Github, and a Wordpress. Actual APM code was managed via Github in order to take advantage of Github's version control capabilities. All other team data, simulation code, and photos were uploaded into categorically defined folders in our Google Drive. Spreadsheets recording budget, weather data, contact information, useful links, and most importantly, problem set requirements were also held here. Having all of these documents in a single location and accessible by all of the team was the last step in facilitating good communication and ensured proper problem set completion. Once written, relevant text, data, graphs, and videos were uploaded to skynet241x.wordpress.com.

		\input{mission}
		\label{Mission}

		\section{Airframe Design}
			\label{Vehicle}

			\subsection{Propulsion System Analysis}

			The propulsion system analysis was performed in three parts:
			\begin{enumerate}
				\item Propeller analysis
				\item Motor analysis
				\item Propeller and Motor matching
			\end{enumerate}

			\subsubsection{Propeller Analysis}

			For the propeller analysis, we used wind tunnel experimental data from the UIUC Propeller Data Site \footnote{http://aerospace.illinois.edu/m-selig/props/propDB.html}. The exact same propeller data was unavailable in the database, so we used a very similar propeller (Graupner CAM Slim 9x5) albeit from a different manufacturer.

			The data was given in terms of the rotations per second instead of the angular velocity and hence, the following scaling had to be performed

			\begin{eqnarray*}
				\lambda &=& \frac{J}{\pi} \\
				C_T &=& \left( \frac{2}{3} \right)^3 C_T ^ \prime \\
				C_P &=& \frac{1}{\pi} \left( \frac{2}{3} \right)^3 C_P ^ \prime \\
				\eta &=& \eta ^ \prime
			\end{eqnarray*}
			where $\lambda$ is the advance ratio based on the angular velocity, $J$ is the advance ratio based on the rotations per second, $C_T$ is the thrust coefficient, $C_P$ is the power coefficient and $\eta$ is the propeller efficiency. The primed quantities are the ones reported in the database.

			\subsubsection{Motor Analysis}
			The motor analysis was performed by using the standard electric motor model. The motor speed constant, motor resistance and the no-load motor current were obtained from experimentally measured values on the manufacturer's website \footnote{http://www.maxxprod.com/pdf/HC2808-xxxx.pdf}.

			The values of the model constants are reported below:
			\begin{eqnarray*}
				K_v &=& 980 \left( \frac{2 \pi}{60} \right) \; rad/s/volt \\
				R_m &=& 0.220 \; \Omega \\
				i_0 &=& 0.4 \; A
			\end{eqnarray*}

			\subsubsection{Propeller and Motor Matching}
			For a given free-stream velocity, the required torque for the propeller was calculated as a function of the angular velocity of the propeller. For the motor, the torque generated was calculated as a function of the angular velocity. By matching these two torques, we solved for the angular velocity and obtained the total propulsive efficiency. This process is illustrated in Figure~\ref{fig:prop-motor1}.
			\begin{figure}[h!]
				\centering
				\begin{subfigure}[b]{0.49\textwidth}
					\includegraphics[width=\textwidth]{Figures/PS3/propmotor_v07p0.png}
					\caption{$v = 7 \; m/s$}
				\end{subfigure}
				\begin{subfigure}[b]{0.49\textwidth}
					\includegraphics[width=\textwidth]{Figures/PS3/propmotor_v12p0.png}
					\caption{$v = 12 \; m/s$}
        \end{subfigure}%
        \caption{Propeller-Motor matching shown graphically. Solid lines: propeller curves. Dashed lines: Motor curves}\label{fig:prop-motor1}
    \end{figure}

    For the $7 \; ms^{-1}$ case, we see that the propeller efficiency, $\eta_p$ peaks at very low angular velocities and hence the total propulsive efficiency is poor. For the $12 \; ms^{-1}$ case, the propeller efficiency, $\eta_p$ peaks at high angular velocities which again leads to a low total propulsive efficiency. Optimizing the total propulsive efficiency over different airspeeds, we get the best motor-propeller matching illustrated in Figure~\ref{fig:prop-motor2}

    \begin{figure}[h!]
    	\centering
    	\includegraphics[width=\textwidth]{Figures/PS3/propmotor_opt.png}
    	\caption{Optimal Propeller-Motor matching shown graphically. Solid lines: propeller curves. Dashed lines: Motor curves}\label{fig:prop-motor2}
    \end{figure}

    The total propulsive efficiency and the thrust are plotted against airspeed in Figure~\ref{fig:teff-thrust}.

    \begin{figure}[h!]
    	\centering
    	\begin{subfigure}[b]{0.49\textwidth}
    		\includegraphics[width=\textwidth]{Figures/PS3/Teff.png}
    		\caption{Plot of the total propulsive efficiency against airspeed}
    	\end{subfigure}
    	\begin{subfigure}[b]{0.49\textwidth}
    		\includegraphics[width=\textwidth]{Figures/PS3/Thrust.png}
    		\caption{Plot of the total thrust against airspeed}
        \end{subfigure}%
        \caption{Thrust and efficiency plots}\label{fig:teff-thrust}
    \end{figure}

    \subsection{Design Approach}
    \label{DsignAppr}

    For our mission plan, it is critical that we climb to an altitude of $400 ft$ as fast as we can to efficiently scout the search area and sight all four targets as soon as we can. Hence, the rate of climb for our airplane is of crucial importance. In addition to this, the endurance of our aircraft is also very important since the allowed battery consumption is very limiting. We designed our aircraft mainly based on these two considerations.

    First, we obtained the drag polar for a generic 2D semi-symmetrical airfoil section (Clark-Y) in XFLR5 that we used as our first estimates for our full aircraft drag polar. From some preliminary weight estimates, we allotted a $450g$ weight budget for our aircraft. Using this weight and the 2D drag polars data, we found the wing area that would maximize our rate of climb using the data from the analysis of the propulsion system. We chose a taper ratio of $0.5$ for our wing. This choice was influenced by structural constraints on the total root bending moment and the stall characteristics so that in the event of a stalled aircraft, aileron control is not lost. Then, we assumed an aspect ratio of $6.8$ (that of the Bixler 2). This allowed us to construct a wing in XFLR5 to get a more realistic drag polar. This process was repeated iteratively until convergence. However, we changed our aspect ratio to $10$ since we felt it would be possible to make a wing with that aspect ratio that is still rigid enough.

    After this preliminary analysis, we did the same analysis with different airfoil sections and chose the SD-7037 airfoil section since the predicted $(L/D)_{max}$ was the highest for this airfoil. The effect of the choice of airfoil section on the climb performance was found to be minimal and hence we were able to perform a decoupled analysis for the choice of airfoil sections.

    Then, we calculated the horizontal stabilizer area from considerations of the longitudinal stability that were backed by Vortex Lattice Model predictions. The vertical stabilizer size was chosen based on previous aircraft designs similar to our aircraft and then validated using stability analysis in AVL.

    \begin{figure}[h!]
    	\centering
    	\includegraphics[width=0.7\textwidth]{Figures/PS3/SkynetV3_XFLR_pic.png}
    	\caption{VLM model of our design in XFLR5}\label{fig:vlm-design}
    \end{figure}

    \subsection{Performance Characteristics}
    \label{PerfChar}

    The different performance parameters of our design as predicted by XFLR5 are shown in Figures~\ref{fig:cl-alpha} to \ref{fig:power-cons}.

    \begin{figure}[h!]
    	\centering
    	\includegraphics[width=0.7\textwidth]{Figures/PS3/CL_vs_alpha.png}
    	\caption{$C_L$ vs $\alpha$}\label{fig:cl-alpha}
    \end{figure}
    \begin{figure}[h!]
    	\centering
    	\includegraphics[width=0.7\textwidth]{Figures/PS3/CL_vs_CD.png}
    	\caption{Drag polar}\label{fig:cl-cd}
    \end{figure}
    \begin{figure}[h!]
    	\centering
    	\includegraphics[width=0.7\textwidth]{Figures/PS3/CL-CD_vs_V.png}
    	\caption{$C_L/C_D$ vs $v_\infty$}\label{fig:LD-v}
    \end{figure}
    \begin{figure}[h!]
    	\centering
    	\includegraphics[width=0.7\textwidth]{Figures/PS3/Cm_vs_alpha.png}
    	\caption{$C_m$ vs $\alpha$}\label{fig:cm-alpha}
    \end{figure}
    \begin{figure}[h!]
    	\centering
    	\includegraphics[width=0.7\textwidth]{Figures/PS3/power_consumption.png}
    	\caption{$P_{level}$ vs airspeed}\label{fig:power-cons}
    \end{figure}

    A comparison of the performance parameters estimated from our analysis with the performance parameters obtained from measured data during flight tests in shown in Table~\ref{table:Compar}.

    \begin{table}[htb]
    	\begin{center}
    		\begin{tabular}{|c|c|c|c|c|c|}
    			\hline
    			\textbf{} & \textbf{$C_L\;max$} & \textbf{$(L/D)_{max}$} & \textbf{$P_{level}$ $(9.5 \; ms^{-1})$} & $P_{level}$ $(13.5 \; ms^{-1})$  & \textbf{$P_{max\;climb}$} \\ 
    			\hline
    			\textbf{Estimated} & $1.14$ & $19.0$ & $11.29\;watts$ & $28.62\;watts$ & $34.12\;watts$  \\
    			\textbf{Measured}  & $0.73$ & $16.3$ & $7.45\;watts$ & $26.47\;watts$ & $39.98\;watts$  \\
    			\hline
    		\end{tabular}
    	\end{center}
    	\caption{Estimated vs. measured flight performance parameters}
    	\label{table:Compar} 
    \end{table}

    \subsection{Stability Analysis}

    The stability analysis of our design was performed in AVL. Three different straight and level flight trim states and one level turn trim state were analysed. The four cases used are listed in Table~\ref{table:stab-cases}.

    \begin{table}[htb]
    	\begin{center}
    		\begin{tabular}{|c|c|c|}
    			\hline
    			\textbf{Case} & \textbf{Airspeed (in m/s)} & \textbf{Bank Angle (in degrees)} \\ 
    			\hline
    			Case 1 &  $8.5$ &  $0$ \\
    			Case 2 &  $7.0$ &  $0$ \\
    			Case 3 & $10.0$ &  $0$ \\
    			Case 4 &  $8.5$ & $30$ \\
    			\hline
    		\end{tabular}
    	\end{center}
    	\caption{Different cases for stability analysis in AVL}
    	\label{table:stab-cases} 
    \end{table}

    The eigenvalues, frequencies and damping ratios for the different modes are plotted in Figures~\ref{fig:eig},~\ref{fig:freq} and \ref{fig:damp}.

    \begin{figure}[h!]
    	\centering
    	\includegraphics[width=0.7\textwidth]{Figures/PS2/SkynetV1_eig.png}
    	\caption{Eigenvalue plot}\label{fig:eig}
    \end{figure}
    \begin{figure}[h!]
    	\centering
    	\includegraphics[width=0.7\textwidth]{Figures/PS2/SkynetV1_freq.png}
    	\caption{Frequency}\label{fig:freq}
    \end{figure}
    \begin{figure}[h!]
    	\centering
    	\includegraphics[width=0.7\textwidth]{Figures/PS2/SkynetV1_damp.png}
    	\caption{Damping ratio}\label{fig:damp}
    \end{figure}

    \subsection{Three-view drawings of the final design}

    Figure~\ref{fig:CAD} shows the CAD drawings of our final design. Figure~\ref{fig:SW} shows the SolidWorks model of our design that we used to get all the parts for the laser cutter.

    \begin{figure}[h!]
    	\centering
    	\includegraphics[width=\textwidth]{Figures/CAD/Aircraft_Design_3-3.png}
    	\caption{CAD drawings of the final design}\label{fig:CAD}
    \end{figure}

    \begin{figure}[h!]
    	\centering
    	\begin{subfigure}[b]{0.49\textwidth}
    		\includegraphics[width=\textwidth]{Figures/CAD/iso.png}
    		\caption{Isometric view}
    	\end{subfigure}
    	\begin{subfigure}[b]{0.49\textwidth}
    		\includegraphics[width=\textwidth]{Figures/CAD/top.png}
    		\caption{Top view}
    	\end{subfigure}
    	\\
    	\begin{subfigure}[b]{0.49\textwidth}
    		\includegraphics[width=\textwidth]{Figures/CAD/side.png}
    		\caption{Side view}
    	\end{subfigure}
    	\begin{subfigure}[b]{0.49\textwidth}
    		\includegraphics[width=\textwidth]{Figures/CAD/front.png}
    		\caption{Front view}
        \end{subfigure}%
        \caption{Solidworks model screenshots}\label{fig:SW}
    \end{figure}

\FloatBarrier
\section{Controls}
\label{Controls}
\subsection{Control Strategy}
\label{CtrlStr}

The controller for the aircraft used successive loop closure to obtain the closed loop performance necessary to complete our missions. The strategy was to provide the navigation team with a robust interface that they could use to carry out the mission. This interface sectioned off the inner loop controls from the outer loop / guidance and navigation controls. The interface that the navigation team had to work with was commanded ground speed, commanded heading, and commanded altitude. These three references were used dynamically by the navigation team to carry out our complete mission.

Waypoint navigation was obtained by commanding heading, ground speed, and altitude in the medium (10 Hz) AUTO loop. The inner loop controllers ran at within the 50 Hz loop to maintain the commanded heading, ground speed, and altitude. This interface was the most important, and most difficult to realize in order to accomplish the relatively complex mission profile.

\paragraph{Inner Loop Controllers}
The inner most controllers consisted of three PID loops to command throttle, elevator deflection, and aileron deflection. To obtain the correct airspeed, a throttle scheduler was used as a feedforward term to overcome the nonlinearities in the throttle command over the aircraft's airspeed envelope. For the pitch and roll controllers, simple PI control sufficed.

\begin{figure}[h!]
\centering
\includegraphics[width=\textwidth]{./Figures/PitchAngleController}
\caption{Pitch Angle Controller}
\label{fig:PitchAngleController}
\end{figure}

\begin{figure}[h!]
\centering
\includegraphics[width=\textwidth]{./Figures/RollAngleController}
\caption{Roll Angle Controller}
\label{fig:RollAngleController}
\end{figure}

\begin{figure}[h!]
\centering
\includegraphics[width=\textwidth]{./Figures/AirspeedController}
\caption{Airspeed Controller}
\label{fig:AirspeedController}
\end{figure}

The altitude controller relied on the ability of the airspeed controller to maintain a relatively constant airspeed even with disturbances due to wind, roll angle changes, and pitch angle changes in the aircraft. Trim states for steady level flight, 15 degree roll turns, and 30 degree roll turns were determined experimentally across the entire airspeed envelope of 8.5 m/s to 13.5 m/s. Once the trim state altitude holding states were known, the pitch angle scheduler was built using switch case statements and a discretized state space of the airspeed and roll angle commands. The altitude controller relied heavily on the scheduler and only allowed small perturbations in pitch angle to maintain the altitude. The limiters on this controller in particular were too restrictive to begin with and therefore in windy conditions, the controller did not have enough authority to maintain constant altitude.

\begin{figure}[h!]
\centering
\includegraphics[width=\textwidth]{./Figures/AltitudeController}
\caption{Altitude Controller}
\label{fig:AltitudeController}
\end{figure}

The heading controller looped around the roll angle controller to provide the navigation team with heading command tracking. The heading controller was the only controller to use full PID control in order to dampen the oscillations of heading hold / heading tracking at low airspeeds. The introduction of derivative term control was key in gaining robustness in the controller during the refinement phase of our mission at the low (sub 9 m/s) airspeeds.

\begin{figure}[h!]
\centering
\includegraphics[width=\textwidth]{./Figures/HeadingController}
\caption{Heading Controller}
\label{fig:HeadingController}
\end{figure}

The last of the inner loop controllers to be used to provide the complete interface for the navigation team was the ground speed controller. This controller took a ground speed reference that was dynamically updating from the mission management and commanded an airspeed for the airspeed controller to track. In reality, we never really got around to dynamically changing the ground speed and simply opted to maintain a single ground speed in the first phase of the mission and a second (slower) ground speed during the second phase of the mission.

\begin{figure}[h!]
\centering
\includegraphics[width=\textwidth]{./Figures/GroundSpeedController}
\caption{Ground Speed Controller}
\label{fig:GroundSpeedController}
\end{figure}

\subsection{Flight Performance}
\label{CtrlFlightPerf}
% BRANDON
% Include in this section Initial Approach vs. Final Choices

The successive loop strategy worked well for the job that was required by our mission plan. Experimental results were almost always needed in order to tune the gains for each individual controller and an extensive steady state level flight / banked constant altitude set of experiments led to the trim schedulers needed. The initial plan for controller design was to use a quick successive loop closure controller for the preliminary problem sets and migrate to a linear quadratic regulator eventually. The quick controller was programmed in C++ and ready for testing several weeks prior to the line tracking problem set. However, our team ran up against two road blocks: the first was that we needed CAD models of the aircraft design in order to laser cut the aircraft, the second was that we ran out of flash memory and weren't aware that we could remove much of the APM code to give us more program memory space.

The first issue caused the controller design to halt for about 10-14 days while laser cut prototypes were cut, built, and tested. The second issue caused a complete refactoring of the simple inner loop controls in order to get something flyable as soon as possible. By the time these two issues were resolved, there was no time to continue development on the LQR controller.

\begin{figure}[h!]
\centering
\includegraphics[width=\textwidth]{./Figures/AltitudeHoldPerformance}
\caption{Altitude Hold Performance}
\label{fig:AltitudeHoldPerformance}
\end{figure}

\begin{figure}[h!]
\centering
\includegraphics[width=\textwidth]{./Figures/AirspeedHoldPerformance}
\caption{Airspeed Hold Performance}
\label{fig:AirspeedHoldPerformance}
\end{figure}

\begin{figure}[h!]
\centering
\includegraphics[width=\textwidth]{./Figures/PositionHistory}
\caption{XY Position History}
\label{fig:PositionHistory}
\end{figure}


Figures \ref{fig:AirspeedHoldPerformance} and \ref{fig:AltitudeHoldPerformance} demonstrate the inner loop controllers' ability to hold airspeed and altitude during the mission. The heading control acheived is evidenced by the XY gps position time history of our missions (Figure \ref{fig:PositionHistory}).

\FloatBarrier
\section{Fabrication}
	\label{Fabrication}
	\subsection{Prototype Construction Approach}
	\label{ProtoConsAppr}
	\subsubsection{Mk-I "The Red Baron"}
	\label{mk1}
	\subsubsection{Mk-II "The Pig"}
	\label{mk2}
	\subsubsection{Mk-III.1}
	\label{mk3.1}
	\subsubsection{Mk-III.2 "Ronald McDonald"}
	\label{mk3.2}
	\subsubsection{Mk-III.3 "Terminator"}
	\label{mk3.3}
	\subsubsection{Mk-III.4 "The UltraLight"}
	\label{mk3.4}

%%%%%%%%%%%%%%%% Start: Flight Testing %%%%%%%%%%%%%%%%%%%
\section{Flight Testing}
	\label{FlightTesting}
	Over the course of two weeks, before and during the final competition, the flight test team worked extensively to try to successfully implement the strategies described in section \ref{Mission}. It was decided very early during flight testing that the only way to accomplish the task was to add sections of the mission incrementally. A strategy of "coding at night, flying in the morning" was implemented and each section of the mission was tested in a simulator, tested during flight and gradually changed to improve performance and accommodate realistic goals.

	\subsection{Flight Test Approach}
	\label{FltTstAppr}
	Flight testing was split into three major sections: Waypoint Navigation, Phase 1 testing and Phase 2 testing. The goal of waypoint navigation was to successful traverse a spiral given a set number of waypoints. Phase 1 testing included all sections of flight before a time of sight for all targets is found. Phase 2 testing included the refinement process for each target and on board calculations of estimated target locations.

	\subsubsection{Waypoint Navigation}
	The entire mission consists of flying one spiral around the center of the lake to find all targets and flying circles around constantly changing centroids during target refinement. This is much different from the line transitioning which was the goal of problem set 3. During flight testing, the line transitioning algorithm presented in problem set 3 proved to be unfavorable. A small change was made to the algorithm to be able to smoothly traverse waypoints in a circular pattern.\\

	As a reminder, in problem set 3, waypoint vectors point between waypoints while the plane vector always points from the plane to the current waypoint. These are used to compute a heading error which is then coupled with a proportional gain to compute a heading command. If the waypoint is found within a certain specified error radius, the plane will head towards the next waypoint. For sprials, the following new equations are used to compute waypoint heading vector angles,
	\begin{align*}
		\mbox{For a circular path: } H_{wp} &= atan2((y_{wp}-y_{centroid}),(x_{wp}-x_{centroid})) + \pi /2 \\
		\mbox{For transition between spirals: } H_{wp} &= atan2((y_{wp,i+1}-y_{wp,i}),(x_{wp,i+1}-x_{wp,i}))
	\end{align*}
	where $(x_{wp},y_{wp})$ are waypoint locations. The first equation forces the plane to track a line tangent to a circle centered around a specified centroid $(x_{centroid},y_{centroid})$. For the spiral, the centroid is set to $(0,0)$. For phase 2 refinement, the centroid is changes according to target locations. The second equation is forces the plane to track a line between waypoints. This is essential for moving between inner circles of the spiral. During flight testing, these proved to be the most robust.\\

	To improve reliability, a check was made to ensure the plane would always move towards a waypoint. If the plane was outside a 45 degree field of view of the waypoint or if the plane was within 10 meters of a waypoint, the plane was commanded to move directly towards the waypoint.

	\subsubsection{Phase 1 testing}
	At the start of a mission, the plane is commanded to increase in altitude at a maximum climb rate to a specified altitude. Once the altitude is reached, the plane flies through a series of transition points which help it navigate into a spiral more smoothly. Once the spiral is initiated, snapshots are taken at each waypoint to ensure maximum coverage of the entire area. Phase 1 transitions into phase 2 once all targets are acquired. If all targets are not found within the spiral, the plane reinitializes a new spiral.\\

	First, the mission spiral was tested without taking snapshots to ensure the waypoint navigation was working correctly. We ran into two major problems with the APM board and the Starduplane code during this phase of testing.
	\begin{enumerate}
		\item \textbf{Flash Memory Problem:} In problem set 3, we ran into memory issues when the majority of our code was written in classes and dynamically allocatable containers. This time, the memory issue arose because of the amount of floats being stored. When a dynamically allocatable array allocates more memory during runtime when there is no more memory to allocate, the APM board seems to overwrite other memory addresses. To avoid this issue and weird behaviors during flight time (Nose Dives!), static arrays were created so that an error message would be received during compile time. Unfortuanely, storing the 52 waypoints required for the spiral (104 floats) was too much for the APM board.
		\item \textbf{Initialization Problem:} A major problem arises when trying to limit a command to only happen once during initialization of auto mode. Using only the "just switched to AUTO" logic found in Starduplane does not ensure that a command only happens once during auto mode. This may be caused by the fact that sometimes it may take longer than 100 ms to return to the fast loop.
	\end{enumerate}

	Both of these issues took an extensive amount of time to fix. After going through several iterations, the following solutions were concluded.
	\begin{enumerate}
		\item \textbf{Solution to Flash Memory Problem:} To limit the amount of static floats stored in flash during phase 1, a function was created to produce waypoints on the fly during the spiral. An optimal spiral function is created depending on the location where the initial climb to max altitude ends. The spiral changes on each run but this ensures that the plane starts the spiral as close as possible and that flash memory isn't filled with waypoint data.
		\item \textbf{Solution to Initialization issues:} To ensure that a spiral is only created once during auto mode, a parameter is created to act as a flag. Before a mission is flown, the parameter is set to zero in Mission Planner. Once the program initializes the spiral, the flag is set to 1 and the program can no longer initialize a spiral.
	\end{enumerate}

	Once these bugs were fixed, the team was able to implement snapshot capturing. Snapshots must be taken at each waypoint during the spiral to ensure maximum coverage of the entire area. If a snapshot is not captured at a waypoint, the plane circles around the waypoint until a snapshot is taken. To limit the amount of waypoint misses, the waypoints were spread further apart. An snapshot error was set to 5 meters so that snapshots/waypoints were guaranteed to be hit within a 5 meter radius. The airspeed was also reduced to 11 m/s.\\

	One of the last features implemented in phase 1 was a controlled climb with snapshots...

%%%%%%%%%% Brandon please add Phase 1 - Climb flight testing here %%%%%%%%%%%

By taking snapshots while climbing at the center, we were able to sometimes get lucky and capture a target before going into a spiral.

\subsubsection{Phase 2 testing}
%%%%% Akshay please add everything you can about the flight testing of Phase 2 here %%%%%
% Step 1: adding phase 2 simple
The whole algorithm for refining the position estimates of the targets was designed in MATLAB. The use of intrinsic MATLAB functions and the complexity of the code made porting the full code to C for the APM a challenging task. To ensure that we minimize the number of bugs and logic errors made during the process of porting the code, we first designed an outrageously simple algorithm for phase 2 as a base case and built all of the complexity on top of this simple base case. \\

Once phase 1 was tested and we were confident that it would work in most cases, the simple version of phase 2 was added. The first iteration did not have any snapshot functionality or intelligent way of choosing the order in which the targets were refined. Once this was working well, we added the snapshot functionality and made sure that we were able to do a complete mission. \\

% Step 2: removing phase 2 simple and adding all of the refinement
After testing the simple version of phase 2, we ported our full algorithm for phase 2 and tested it on the computer before moving it to the APM. The integration of the full phase 2 code with the APM software caused some issues. These were mainly because we were trying to reduce the memory footprint of our code as much as possible. \\

% Problems we had: Flash memory issue with storing snapshots, the dreaded unsigned int...
The biggest issue with our refinement logic was the necessity to store all our snapshot data as opposed to keeping a running average of all the camera estimate and relying just on gaussian convergence. We ran into a lot of issues with the RAM limit and the APM board overwriting some data. We fixed this issue first by reducing the amount of internal memory used in our code and by moving some of our constant arrays (gains, control limits, etc.) to the program memory and reading it when needed. Although this made our code better, we still had some issues that were caused by assigning a negative number to a flag that was defined as an unsigned integer. Once we fixed these issues, we were able to complete a full mission and get very high refinement scores. \\

%%%%% Akshay please add everything you can about the flight testing of Phase 2 here %%%%%

\subsection{Simulation vs. Actual Tests}
\label{simvsact}
%%% Kartikey please summarize the differences between your envisioned mission plan and what the plane actually does %%%
The plane performed better than expected in most aspects of the mission plan. The only real issue in being able to deliver results similar to the mission simulator was the ability of the plane to maintain constant airspeed and altitude. The mission did not work properly when the conditions were windy. A small wind could change the plane's airspeed or altitude dramatically which lead to lower scores. The mission would have performed much more reliably if the plane could properly maintain altitude and airspeed even in windy conditions.\\

Another big difference between the actual mission and the mission strategy was the time to sight all targets. Realistically, it was much more difficult to fly a fast speed and still capture waypoints with an extreme precision. The mission speed had to be reduced to accommodate for the realistic flight speeds of the plane.

%%%%%%%%%%%%%%%% End: Flight Testing %%%%%%%%%%%%%%%%%%%


\section{Mission Flight Results}
	\label{MissionFlightResults}
	\subsection{Official Flight Results}
	\label{OffFltRes}
\begin{table}[!ht]
\caption{Official Mission Results}
\label{tab:ResultsSummary}
\begin{center}
    \begin{tabular}{ | c | p{2cm} | p{2cm} | p{2cm} | p{2cm} | p{2cm} |}
    \hline
    \textbf{Flight} & \textbf{TSight (s)} & \textbf{Target 1 \newline Error (m)} & \textbf{Target 2 \newline Error (m)} & \textbf{Target 3 \newline Error (m)} & \textbf{Target 4 \newline Error (m)} \\ \hline
    1 & 141.53 & 1.8183 & 0.4111 & 0.7625 & 0.7098\\ \hline
    2 & 205.74 & 0.6828 & 2.0479 & 3.6567 & 0.9145\\ \hline
    3 & 521.34 & 3.1966 & 5.3386 & 3.2230 & 0.6872\\ \hline
    4 & 196.65 & 0.8939 & 1.0020 & 1.0646 & 0.3040\\ \hline
    5 & 201.90 & 1.6150 & 1.2499 & 13.7072 & 1.6107\\ \hline
    \end{tabular}
\end{center}
\end{table}

\begin{table}[!ht]
\caption{Summary of Official Mission Scores}
\label{tab:ScoreSummary}
\begin{center}
    \begin{tabular}{ | c | c | c | c | c | p{3cm} |}
    \hline
    \textbf{Flight} & \textbf{Date} & \textbf{Phase 1} & \textbf{Phase 2} & \textbf{Total} & \textbf{Comments} \\ \hline
    1 & 6/6/2014 & 38.08 & 38.76 & 76.84 & \\ \hline
    2 & 6/6/2014 & 26.87 & 23.39 & 50.26 & Dropped\\ \hline
    3 & 6/6/2014 & 11.99 & 13.28 & 25.27 & Dropped\\ \hline
    4 & 6/7/2014 & 27.96 & 46.65 & 74.61 & \\ \hline
    5 & 6/7/2014 & 27.70 & 8.06 & 35.76 & Dropped\\ \hline
    Overall & \multicolumn{5}{c|}{75.725}\\ \hline   
    \end{tabular}
\end{center}
\end{table}

	\subsection{Analysis of Flight Data}
	\label{AnalFltData}
% JERRY & KARTIKEY
% Include observations about about the validity of our approach.
% What observations from the data might inform future work (beyond the scope of the class).
\begin{enumerate}

\item Flight 1. As can be seen from table \ref{tab:ResultsSummary}, all targets except for $\#1$ were refined to perfect accuracy of less than $1m$. This gets reflected in the refinement score of $38.76$. The positioning of the true target locations was well suited to our passive search trajectory which lead to a relatively high score on $t_{sight}$ as well. The battery consumption contains three distinct regions corresponding to climb, low curvature turns in Phase-1 and high curvature turns in Phase-2 respectively. It is interesting to note that our overall mission time exceeded 15 minutes and yet we had more than $40 mAh$ of battery left at the end of the mission. The only point of concern was the loss in altitude towards the final part of Phase-2 when the altitude controller could not provide enough elevator control.

\item Flight 2. The second flight saw the airplane struggling against the wind as the altitude controller failed to maintain altitude during Phase-2. While the battery performance was consistent and the overall mission time was close to 16 minutes, the refinement procedure was restricted as it was designed for the field of view obtained near the highest permissible altitude. The tailwind further affected the effectiveness of the airspeed controller as well, which coupled with the low wing loading of the airframe resulted in dutch roll like instabilities.

\item Flight 3. The third flight on Friday saw our worst score of the five flights, primarily on account of the aircraft flying out of the upper bound on altitude due to a strong thermal. As the navigation protocol during Phase-1 is to continue circling around a waypoint until a successful snapshot is taken, and the snapshot feature is disabled when the aircraft is out bounds, it drained away an excessive amount of battery and mission time. While the mission still managed to procure around $3m$ accuracy on refinement from the residual battery, out $t_{sight}$ score was very low. This flight highlighted serious limitations of the airplane  to operate in windy/thermal conditions.

\item Flight 4. Everything went as theoretically predicted on the fourth flight. Our $t_{sight}$ score was very close to the empirical mean obtained during simulations. The previous flights allowed us to fine tune our altitude controller which helped to keep better control on altitude. Phase-2 was entirely successful as all four of our targets got refined to almost perfect accuracy.

\item Flight 5. Our final flight (and third declared mulligan) suffered at the hands of a particularly ill-positioned target set coupled with a too-simple target-visiting order for Phase-2. The airplane had to traverse the entire trajectory for the passive search in Phase-1 (worst case scenario) which depleted a lot of battery. However, until that flight we had programmed the airplane to simply refine the targets in reverse order of having sighted them in Phase-1 (we included and tested an actual sort procedure thereafter). This non-optimal logic harmed our score severely as a lot of battery got wasted in going back and forth between targets. As can be seen from the plot 	of Target Position Error against time, the refinement procedure needed only an additional $10 s$ to complete refinement on target $\#3$ before the battery ran out. This lead to a poor score on refinement overall, even though the other targets had been refined reasonably.

\end{enumerate}

\section{Conclusions \& Lessons Learned}
	\label{Conclusion}
% EVERYONE

\section{Future AA241X Recommendations}
	\label{Recommendations}
% EVERYONE

\end{document}
